apiVersion: v1
kind: ConfigMap
metadata:
  name: homebridge-configmap
  namespace: homebridge
data:
  config.json: |
    {
        "bridge": {
            "name": "Homebridge 534A",
            "username": "0E:74:81:4D:53:4A",
            "port": 51221,
            "pin": "523-14-925",
            "advertiser": "bonjour-hap"
        },
        "platforms": [
            {
                "platform": "config",
                "port": 8090,
                "name": "Config"
            },
            {
                "interval": 30,
                "platform": "midea-air",
                "password": "$HOMEBRIDGE_MIDEA_PASSWORD",
                "user": "$HOMEBRIDGE_MIDEA_USER",
                "devices": [
                    {
                        "OutdoorTemperature": true,
                        "supportedSwingMode": "Both",
                        "deviceId": "$HOMEBRIDGE_MIDEA_DEVICE_ID",
                        "fanOnlyMode": true
                    }
                ]
            },
            {
                "app_list": true,
                "devices": [
                    {
                        "name": "Samsung TV 65",
                        "ip": "192.168.1.140",
                        "mac": "$HOMEBRIDGE_TV_MAC",
                        "inputs": [
                            {
                                "type": "app",
                                "name": "Netflix",
                                "value": "11101200001"
                            },
                            {
                                "type": "app",
                                "name": "YouTube",
                                "value": "111299001912"
                            },
                            {
                                "type": "app",
                                "name": "Spotify",
                                "value": "3201606009684"
                            }
                        ]
                    }
                ],
                "platform": "SamsungTizen"
            }
        ],
        "accessories": [
            {
                "name": "Roborock S5",
                "ip": "192.168.1.202",
                "token": "$HOMEBRIDGE_XIAOMI_TOKEN",
                "waterBox": false,
                "silent": false,
                "pause": true,
                "pauseWord": "pause",
                "findMe": true,
                "findMeWord": "where are you",
                "dock": true,
                "cleanword": "cleaning",
                "roomTimeout": 0,
                "autoroom": false,
                "accessory": "XiaomiRoborockVacuum"
            }
        ]
    }
  auth.json: |
    [
      {
          "id": 1,
          "username": "$HOMEBRIDGE_ADMIN_USER",
          "name": "$HOMEBRIDGE_ADMIN_USER",
          "hashedPassword": "$HOMEBRIDGE_ADMIN_PASSWORD",
          "salt": "$HOMEBRIDGE_ADMIN_SALT",
          "admin": true
      }
    ]
  startup.sh: |
    #!/bin/bash

    # install plugins
    /opt/homebridge/lib/node_modules/homebridge-config-ui-x/plugin-upgrade-install.sh homebridge-midea-air 1.7.3 /var/lib/homebridge/node_modules
    /opt/homebridge/lib/node_modules/homebridge-config-ui-x/plugin-upgrade-install.sh homebridge-xiaomi-roborock-vacuum 0.29.0 /var/lib/homebridge/node_modules
    /opt/homebridge/lib/node_modules/homebridge-config-ui-x/plugin-upgrade-install.sh homebridge-samsung-tizen 5.2.6 /var/lib/homebridge/node_modules

    # install envsubst
    apt-get update
    apt-get install gettext-base

    # pass secrets to config files from env variables
    envsubst < /homebridge/config.json.template > /homebridge/config.json
    envsubst < /homebridge/auth.json.template > /homebridge/auth.json